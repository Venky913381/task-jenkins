pipeline {
    agent any
    
    environment {
        AWS_REGION = 'ap-south-1'
    }
    
    stages {
        stage('Install Tools') {
            steps {
                script {
                    echo 'Installing required tools...'
                    // Install Terraform
                    sh '''
                        curl -LO https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
                        unzip -q terraform_1.5.0_linux_amd64.zip
                        chmod +x terraform
                        mv terraform /usr/local/bin/
                    '''
                    // Install TFSec
                    sh '''
                        curl -L -o tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64
                        chmod +x tfsec
                        mv tfsec /usr/local/bin/
                    '''
                    // Verify installations
                    sh '''
                        terraform version
                        tfsec --version
                    '''
                }
            }
        }
        
        stage('Checkout Code') {
            steps {
                script {
                    echo 'üì• Checking out source code...'
                    sh '''
                        if [ ! -d "task-jenkins" ]; then
                            git clone https://github.com/Venky913381/task-jenkins.git
                        else
                            cd task-jenkins && git pull origin master
                        fi
                    '''
                }
            }
        }
        
        stage('Configure AWS Credentials') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'awscredentials',  // Using your AWS credentials ID
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    script {
                        echo 'üîë Configuring AWS credentials...'
                        sh '''
                            echo "AWS Access Key ID configured successfully"
                            echo "AWS Region: ${AWS_REGION}"
                        '''
                    }
                }
            }
        }
        
        stage('Security Scan - TFSec') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'awscredentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    dir('task-jenkins/terraform_task') {
                        script {
                            echo 'üîí Running TFSec Security Scan...'
                            sh '''
                                echo "=== TFSec Security Scan Results ==="
                                set +e  # Disable exit on error
                                tfsec . --format text --out tfsec-results.txt
                                EXIT_CODE=$?
                                set -e  # Re-enable exit on error
                                
                                echo "=== Scan Results ==="
                                cat tfsec-results.txt
                                
                                if [ $EXIT_CODE -eq 0 ]; then
                                    echo "‚úÖ TFSec scan passed - no security issues found"
                                elif [ $EXIT_CODE -eq 1 ]; then
                                    echo "‚ö†Ô∏è TFSec found security issues - check report above"
                                else
                                    echo "‚ùå TFSec scan failed with exit code: $EXIT_CODE"
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Terraform Init & Validate') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'awscredentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    dir('task-jenkins/terraform_task') {
                        script {
                            echo 'üöÄ Initializing Terraform...'
                            sh 'terraform init -input=false -reconfigure'
                            
                            echo '‚úÖ Validating Terraform configuration...'
                            sh 'terraform validate'
                        }
                    }
                }
            }
        }
        
        stage('Terraform Plan') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'awscredentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    dir('task-jenkins/terraform_task') {
                        script {
                            echo 'üìã Generating Terraform plan...'
                            sh 'terraform plan -out=tfplan -input=false'
                        }
                    }
                }
            }
        }
        
        stage('Manual Approval') {
            steps {
                script {
                    echo '‚è≥ Waiting for manual approval...'
                    input message: 'Proceed with Terraform apply?', ok: 'Yes'
                }
            }
        }
        
        stage('Terraform Apply') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'awscredentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    dir('task-jenkins/terraform_task') {
                        script {
                            echo 'üîÑ Applying Terraform configuration...'
                            sh 'terraform apply -auto-approve -input=false tfplan'
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'üßπ Pipeline execution completed!'
                // Archive TFSec results and Terraform plan
                archiveArtifacts artifacts: 'task-jenkins/terraform_task/tfsec-results.txt', allowEmptyArchive: true
                archiveArtifacts artifacts: 'task-jenkins/terraform_task/tfplan', allowEmptyArchive: true
            }
        }
        success {
            script {
                echo '‚úÖ Pipeline executed successfully!'
            }
        }
        failure {
            script {
                echo '‚ùå Pipeline execution failed!'
                // You can add notification steps here (email, Slack, etc.)
            }
        }
    }
}
